---
import Page from "../layouts/Page.astro";
---

<Page
  title="Hľadanie"
  description="Nájdi články a stránky podľa názvu alebo témy."
  sectionClass="prose prose-lg max-w-none search-page"
  mainClass="search-main"
>
  <form id="site-search" class="flex gap-2 items-center mb-6" role="search">
    <label for="q" class="sr-only">Hľadaj</label>
    <input
      id="q"
      name="q"
      type="search"
      placeholder="Napíš, čo chceš nájsť…"
      class="flex-1 px-4 py-2 rounded-md border border-gray-300"
      autofocus
    />
    <button type="submit" class="btn">Hľadať</button>
  </form>
  <div id="results" aria-live="polite"></div>

  <script>
    const resultsEl = document.getElementById('results');
    function norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
    function tokens(s){ return norm(s).split(/[^a-z0-9]+/).filter(Boolean); }
    function levenshtein(a,b){ const m=a.length,n=b.length; if(!m) return n; if(!n) return m; const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j; for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i; for(let j=1;j<=n;j++){ const tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+(a[i-1]===b[j-1]?0:1)); prev=tmp; } } return dp[n]; }
    function fuzzyScore(hay, needles){ const ht=tokens(hay); let s=0; for(const q of needles){ if(!q) continue; if(ht.some(t=>t.includes(q))){ s++; continue; } let best=Infinity; for(const t of ht){ best=Math.min(best, levenshtein(t,q)); } const thr=q.length<=4?1:2; if(best<=thr) s++; } return s; }
    async function doSearch(query){ const qn=norm(query); if(!qn){ resultsEl.innerHTML=''; return; } const res=await fetch('/search.json'); const data=await res.json(); const qTok=tokens(query); const scored=data.map(p=>{ const ts=fuzzyScore(p.title, qTok); const ds=fuzzyScore(p.description||'', qTok); const cs=fuzzyScore(p.content||'', qTok); const tagstr=Array.isArray(p.tags)?p.tags.join(' '):''; const gs=fuzzyScore(tagstr, qTok); return {...p, score: ts*3+ds+cs+gs}; }).filter(p=>p.score>0).sort((a,b)=> b.score - a.score || (new Date(b.pubDate||0)-new Date(a.pubDate||0))).slice(0,20); resultsEl.innerHTML = scored.length ? `
        <ul class="list-none p-0 m-0 grid grid-cols-1 sm:grid-cols-2 gap-1">
          ${scored.map((p)=>`
            <li class=\"glass !m-2 p-3 rounded-[14px]\">
              <a class=\"block no-underline\" href=\"${p.url}\">
                <span class=\"text-xs text-gray-600\">${p.type==='page'?'Stránka':'Článok'}</span>
                <h3 class=\"posttitle mt-0 leading-snug\">${p.title}</h3>
                ${p.description?`<p class=\\"text-sm text-gray-600\\">${p.description}</p>`:''}
              </a>
            </li>`).join('')}
        </ul>` : '<p>Nič sa nenašlo. Skús iné slová.</p>'; }
    const form = document.getElementById('site-search');
    form && form.addEventListener('submit', (e)=>{ e.preventDefault(); const inp=document.getElementById('q'); const val=inp && 'value' in inp ? inp.value : ''; doSearch(val); try{ const u=new URL(window.location.href); u.searchParams.set('q', val); history.replaceState(null,'',u.toString()); }catch{} });
    const inp=document.getElementById('q');
    inp && inp.addEventListener('input', (e)=> doSearch(e && e.target && 'value' in e.target ? e.target.value : ''));
    // On load: read ?q= and run search
    try{ const u=new URL(window.location.href); const q=u.searchParams.get('q')||''; if(q){ if(inp) inp.value=q; doSearch(q); } }catch{}
  </script>
</Page>

<style is:global>
  .search-main {
    width: 56rem;
    max-width: 90vw;
    margin-inline: auto;

  }
  .search-page > h1 {
    font-size: 1.2rem;
    margin-bottom: 0.2rem;
  }
  .search-page > .page-description {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
  }
  @media (min-width: 768px) {
    .search-page form {
      min-width: 480px;
    }
  }
</style>
