---
// Client-only Supabase comments (moderated):
// - Reads PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_ANON_KEY
// - Lists approved comments for the given slug
// - Submits new comments as pending (is_approved=false set via RLS)
// UI text is Slovak; code identifiers in English
interface Props { slug: string; }
const { slug } = Astro.props as Props;
const canRun = Boolean(import.meta.env.PUBLIC_SUPABASE_URL && import.meta.env.PUBLIC_SUPABASE_ANON_KEY);
---

<section class="comments" aria-label="Komentáre">
  <h2>Komentáre</h2>

  {!canRun && (
    <p class="note">Komentáre sú dočasne vypnuté. Chýba <code>PUBLIC_SUPABASE_URL</code> alebo <code>PUBLIC_SUPABASE_ANON_KEY</code>.</p>
  )}

  {canRun && (
    <>
      <div id="comments-list" data-slug={slug}>
        <div class="loading">Načítavam komentáre…</div>
      </div>
      <hr />
      <form id="comment-form" method="POST" action="javascript:void(0)" onsubmit="return false" novalidate>
        <input type="hidden" name="slug" value={slug} />
        <p>
          <label>Meno
            <input name="name" required maxlength="80" />
          </label>
        </p>
        <p>
          <label>E‑mail (nepovinné)
            <input type="email" name="email" />
          </label>
        </p>
        <p class="hp">
          <label>Nepoužívaj toto pole
            <input name="hp_field" tabindex="-1" autocomplete="off" />
          </label>
        </p>
        <p>
          <label>Komentár
            <textarea name="message" required minlength="3" maxlength="5000"></textarea>
          </label>
        </p>
        <button type="button">Odoslať komentár</button>
        <span id="form-status" role="status" aria-live="polite"></span>
      </form>

      <script type="module">import '/src/assets/comments-client.js';</script>
    </>
  )}

  <style>
    .comments { margin-top: 2rem; }
    .comments h2 { margin-bottom: 0.5rem; }
    .loading, .muted { color: rgb(var(--gray)); }
    .error { color: #e11d48; }
    .comment { padding: 0.75rem 0; border-bottom: 1px solid rgba(0,0,0,0.08); }
    .comment .meta { font-size: 0.9rem; color: rgb(var(--gray)); margin-bottom: 0.25rem; }
    .comment .body { white-space: pre-wrap; }
    form#comment-form { margin-top: 1rem; }
    form#comment-form input, form#comment-form textarea { width: 100%; padding: 0.5rem; }
    form#comment-form .hp { position: absolute; left: -9999px; opacity: 0; height: 0; }
    #form-status { margin-left: 0.75rem; color: rgb(var(--gray)); }
  </style>
</section>
